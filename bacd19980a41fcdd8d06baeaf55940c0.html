

<script>


</script>

<style>
   textarea {
    width: 100%;
    height: 98px;
    margin: 0 0 5px 0;
    font-size: 22px;
   }
   #md_preview {

        font-size: 22px;
        min-height: 50%;
        height: auto;
        width: 70%;
        margin: 30px 20% 0px 15%;
   }
   #main {
        font-size: 22px;
        height: auto;
        width: 70%;
        margin: 30px 20% 0px 15%;
   }

</style>





<div id="md_preview"></div>

<hr>

<div id="main">
    <form id="blog_form" action="./bacd19980a41fcdd8d06baeaf55940c0" target="_blank" method="post" >

        <select id="blog_selection" name="blog_name" onchange="fillcontent(this)">
            <option value="none" select=true>select a blog</option>
            
                <option value="Parametric v.s Non-parametric">Parametric v.s Non-parametric</option>
            
                <option value="Understanding Denoising Diffusion Probabilistic Model (DDPM)">Understanding Denoising Diffusion Probabilistic Model (DDPM)</option>
            
                <option value="test_blog3">test_blog3</option>
            
        </select>
        <input type="checkbox" id="show_hide_box" value="" onchange="show_hidden(this)">  Show hidden files
        <textarea id="blog_content" name="blog_content" oninput="auto_grow(this)" onchange="auto_grow(this)"></textarea>

        <label>else</label>
        <input name="else" id="else_code" type="password">
        <button id="submit_btn">Submit</button>
    </form>
</div>






<script>
    function _fetch(url, params){
        
        return fetch(url,params).then((response) => {
            const promiseArray = [response.status, response.json()]
            return Promise.all(promiseArray)
        }).then(
            (resolved_array) => {
                // console.log(resolved_array)
                const status = resolved_array[0]
                const msg = resolved_array[1].msg
                if(status != 200){
                    // fail
                    throw msg;
                }

                return {
                    "ok": 1,
                    "response": resolved_array[1],
                }
            }
        ).catch((error) =>{
            // console.log("error occurred")
            // console.log(error)
            return  {
                "ok": 0,
                "response": error,
            };
        })


    }
    function auto_grow(element) {
        element.style.height = "100px";
        element.style.height = (element.scrollHeight)+"px";
        
        // show markdown preview
        const converter = new showdown.Converter();
        const html = converter.makeHtml(element.value);
        const md_div_elem = document.getElementById("md_preview")
        md_div_elem.innerHTML = html;
    }
    function show_hidden(obj){
        // show hidden
        if (obj.value != ""){
            return;
        }

        _fetch("bacd19980a41fcdd8d06baeaf55940c0/hidden_files").then(
            (response_dict) => {
                if(response_dict.ok === 0){
                    alert(response_dict.response)
                    return;
                }
                
                obj.value = "done"

                arr = response_dict.reponse.data
                const select_elem = document.getElementById("blog_selection")
                arr.forEach((name)=>{
                    var elem = document.createElement("option")
                    var txt_node = document.createTextNode(name);
                    elem.value = name
                    elem.appendChild(txt_node)
                    select_elem.appendChild(elem);
                })
            }
        )
        /* 
        fetch("bacd19980a41fcdd8d06baeaf55940c0/hidden_files").then(
            (response) => {
                
                const promiseArray = [response.status, response.json()]
                return Promise.all(promiseArray)
            }).then(
            (resolved_array) => {
                
                const status = resolved_array[0]
                const msg = resolved_array[1].msg
                if(status != 200){
                    // fail to find the blog
                    throw msg;
                }

                // filter data
                arr = resolved_array[1].data
                const select_elem = document.getElementById("blog_selection")
                arr.forEach((name)=>{
                    var elem = document.createElement("option")
                    var txt_node = document.createTextNode(name);
                    elem.value = name
                    elem.appendChild(txt_node)
                    select_elem.appendChild(elem);
                })

                console.log(arr)

            }).catch((error) =>{
                console.log("error occurred")
                console.log(error)
            })
        */
    }
    
    function fillcontent(obj){
        if (obj.value == "none"){
            return;
        }

        var blog_name = obj.value

        _fetch("bacd19980a41fcdd8d06baeaf55940c0/" + blog_name).then(
            (response_dict)=>{
                if(response_dict.ok === 0){
                    alert(response_dict.response)
                    return;
                }

                data = response_dict.response.data.replaceAll("\\\"", "\"")
                // postprocess
                const elem = document.getElementById("blog_content")
                elem.value = data
                elem.dispatchEvent(new Event('change'));
            }
        )
        
        /* fetch("bacd19980a41fcdd8d06baeaf55940c0/" + blog_name).then(
            (response) => {
                
                const promiseArray = [response.status, response.json()]
                return Promise.all(promiseArray)
            }).then(
            (resolved_array) => {
                
                const status = resolved_array[0]
                const msg = resolved_array[1].msg
                if(status != 200){
                    // fail to find the blog
                    throw msg;
                }
                
                // filter data
                raw_data = resolved_array[1].data
                data = raw_data.replaceAll("\\\"", "\"")
                // postprocess
                const elem = document.getElementById("blog_content")
                elem.value = data
                elem.dispatchEvent(new Event('change'));

            }).catch((error) =>{
                console.log("error occurred")
                console.log(error)
            })
        */

    }

    var submit_btn = document.getElementById("submit_btn");
    submit_btn.addEventListener("click", submit_form, false)

    function submit_form(event){
        event.preventDefault();
        var lookup = {
            "blog_name": "none",
            "else": "",
            "blog_content": "",
        }

        var form = document.getElementById("blog_form")
        const formData = new FormData(form);

        ret = confirm("Submit the content to below blog?\n"+formData.get("blog_name"))
        if(!ret) return

        for (let [key, value] of formData.entries()) {
            // console.log(key, value)
            if (lookup[key] == value | (key == "blog_name" & value.includes("hide"))){
                // do not send
                alert("Given key value pair is not valid:\nKey:" + key + ", Value:" + value)
                return 
            }
        }

        // post form data
        _fetch("bacd19980a41fcdd8d06baeaf55940c0", {
            method: "post",
            body: formData,
        }).then(
            (response_dict) => {
                if(response_dict.ok === 0){
                    alert(response_dict.response)
                    return;
                }
                msg = response_dict.response.msg;
                alert(msg);
                document.getElementById("else_code").value = ""
            }
        )
        /*
        fetch("bacd19980a41fcdd8d06baeaf55940c0",{
            method: "post",
            body: formData,

        }).then((response)=> response.json())
        .then(
            (data) => {
                alert(data);
                form.reset();
            })
        */

    }

</script>
<script src="https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js"></script>

